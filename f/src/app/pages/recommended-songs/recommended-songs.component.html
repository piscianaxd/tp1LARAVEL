<div class="recommendations-container">
    <!-- Loading -->
    <div *ngIf="loading()" class="loading">
        <p>üéµ Analizando tus gustos musicales...</p>
    </div>

    <!-- Error -->
    <div *ngIf="error() && !loading()" class="error">
        <p>‚ùå {{ error() }}</p>
    </div>

    <!-- Usuario sin historial -->
    <div *ngIf="!loading() && !error() && recommendations().length === 0" class="no-history">
        <div class="no-history-content">
            <div class="music-icon">üéµ</div>
            <h3>A√∫n no has escuchado m√∫sica</h3>
            <p>Comienza a escuchar m√∫sica para que te pueda recomendar canciones basadas en tus gustos.</p>
            <button class="explore-btn" routerLink="/explore">
                Explorar M√∫sica
            </button>
        </div>
    </div>

    <!-- Recomendaciones con layout horizontal y flechas -->
    <section *ngIf="!loading() && !error() && recommendations().length > 0" class="recommendations-section container-xxl px-3 px-md-4 py-4">
        <!-- HEADER UNIFORME COMO RECENT-TRACKS -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <h2 class="h3 fw-bold mb-0">Recomendaciones para ti</h2>
                <p class="text-muted mb-0 mt-1">Basado en tu historial de escucha</p>
            </div>

            <div class="d-flex align-items-center gap-2">
                <button class="nav-arrow nav-arrow-left" (click)="scrollLeft()" [disabled]="!canScrollLeft()" title="Anterior">
                    <i class="bi bi-chevron-left"></i>
                </button>

                <button class="nav-arrow nav-arrow-right" (click)="scrollRight()" [disabled]="!canScrollRight()" title="Siguiente">
                    <i class="bi bi-chevron-right"></i>
                </button>
            </div>
        </div>

        <!-- CONTENEDOR DE C√çRCULOS (MANTIENE IDENTIDAD √öNICA) -->
        <div class="circular-recommendations" #scrollContainer (scroll)="onScroll()">
            <div *ngFor="let song of recommendations()" class="song-circle" (click)="selectSong(song)"
                [class.selected]="isSelected(song)" [title]="song.title + ' - ' + song.artist">

                <!-- Contenedor de imagen con fallback -->
                <div class="image-container">
                    <ng-container *ngIf="!failedImages.has(song.cover); else iconFallback">
                        <img 
                            [src]="song.cover | mediaUrl" 
                            [alt]="'Portada de ' + song.title" 
                            width="224" height="224"
                            decoding="async"
                            class="circle-image"
                            (error)="handleImageError($event, song)"
                            loading="lazy">
                            
                    </ng-container>
                    
                    <ng-template #iconFallback>
                        <div class="image-fallback">
                            <i class="bi bi-music-note-beamed"></i>
                        </div>
                    </ng-template>
                </div>

                <!-- TEXTO SIEMPRE VISIBLE -->
                <div class="song-text">
                    <strong class="song-title">{{ song.title }}</strong>
                    <span class="song-artist">{{ song.artist }}</span>
                    <small class="song-genre">{{ song.genre }}</small>
                </div>
            </div>
        </div>
    </section>
</div>