<!-- Vista principal de playlists (siempre presente, pero oculta cuando hay detalle) -->
<section class="auto-playlists-section" [class.d-none]="showPlaylistDetail()">
  <!-- Loader -->
  <div *ngIf="loading()" class="row g-4">
    <div class="col-6 col-md-4 col-lg-3 col-xl-2" *ngFor="let _ of [0,1,2,3,4,5,6,7]">
      <div class="playlist-card">
        <div class="sk-cover-square mb-3"></div>
        <div class="placeholder-glow mb-2">
          <span class="placeholder col-10"></span>
        </div>
        <div class="placeholder-glow">
          <span class="placeholder col-7"></span>
        </div>
      </div>
    </div>
  </div>

  <!-- Error -->
  <div *ngIf="!loading() && error()" class="alert alert-danger mt-3">
    {{ error() }}
  </div>

  <!-- Mix Popular (Persistente con paginación) -->
  <div *ngIf="!loading() && popularPlaylist()" class="mb-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h3 class="h4 fw-bold mb-0">Mix de Populares</h3>
        <p class="text-muted mb-0">Las canciones más populares</p>
      </div>
      <div class="d-flex gap-2">
        <button class="round-btn" (click)="playPopularPlaylist()" title="Reproducir todo">
          <i class="bi bi-play-fill"></i>
        </button>
        <button class="round-btn" 
                (click)="prevPopularPage()" 
                [disabled]="!canGoPrevPopular()" 
                title="Anterior">
          <i class="bi bi-chevron-left"></i>
        </button>
        <button class="round-btn" 
                (click)="nextPopularPage()" 
                [disabled]="!canGoNextPopular()" 
                title="Siguiente">
          <i class="bi bi-chevron-right"></i>
        </button>
      </div>
    </div>

    <!-- Grid 3 columnas igual que Recent Track -->
    <div *ngIf="!loading() && !error() && getCurrentPopularSongs().length > 0" class="row g-4">
      <div class="col-12 col-md-6 col-lg-4" *ngFor="let col of getPopularColumns()">
        <ul class="list-group list-group-flush">
          <li class="list-group-item bg-transparent px-0" *ngFor="let song of col">
            <div class="d-flex align-items-center gap-3 popular-item"
                (click)="playSong(song, $event)" 
                (contextmenu)="onTrackContextMenu($event, song)"
                role="button">

              <!-- Cover con overlay -->
              <div class="cover-wrap">
                <ng-container *ngIf="!noImg.has(song.id); else iconFallback">
                  <img
                    [src]="(song.art_work_song | mediaUrl) + bust(song.id)"
                    [alt]="song.name_song"
                    width="56" height="56"
                    class="cover-img"
                    loading="lazy"
                    (error)="onImgError($event, song)"
                  />
                </ng-container>

                <ng-template #iconFallback>
                  <div class="cover-fallback">
                    <i class="bi bi-music-note-beamed"></i>
                  </div>
                </ng-template>

                <!-- overlay: solo Play -->
                <button class="overlay-btn play"
                        (click)="$event.stopPropagation(); playSong(song, $event)"
                        title="Reproducir">
                  <i class="bi bi-play-fill"></i>
                </button>
              </div>

            <ng-template #iconFallback>
              <div class="cover-fallback-square">
                <i class="bi bi-music-note-beamed"></i>
              </div>

              <!-- Acciones al extremo derecho - NUEVO: Botón + para agregar a playlist -->
              <div class="end-actions">
                <button class="icon-btn"
                        (click)="$event.stopPropagation(); openAddToPlaylist(song)"
                        title="Agregar a playlist">
                  <i class="bi bi-plus-lg"></i>
                </button>
              </div>

            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<!-- Playlists por género (ESTILO CIRCULAR) -->
<div *ngIf="!loading() && !error() && playlists().length > 0" class="recommendations-section">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h3 class="h4 fw-bold mb-0 text-light">Descubrí nuevas playlists</h3>
    </div>
    <div class="d-flex gap-2">
      <button class="nav-arrow" (click)="scrollLeft()" [disabled]="!canScrollLeft()" title="Anterior">
        <i class="bi bi-chevron-left"></i>
      </button>
      <button class="nav-arrow" (click)="scrollRight()" [disabled]="!canScrollRight()" title="Siguiente">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </div>

  <!-- Carrusel circular -->
  <div class="circular-recommendations" #scrollContainer (scroll)="onScroll()">
    <div class="song-circle" *ngFor="let playlist of getCurrentPlaylists()" class="song-circle" (click)="openPlaylist(playlist)">
  <div class="image-container">
    <!-- Cinta superior -->
    <div class="ribbon">{{ playlist.name }}</div>

    <!-- Imagen o fallback -->
    <ng-container *ngIf="getCoverImage(playlist); else fallback">
      <img
        [src]="(getCoverImage(playlist) | mediaUrl) + bust(playlist.songs[0].id || 0)"
        [alt]="playlist.name"
        class="circle-image"
        loading="lazy"
        (error)="playlist.songs[0] && onImgError($event, playlist.songs[0])"
      />
    </ng-container>

    <ng-template #fallback>
      <div class="image-fallback">
        <i class="bi bi-collection-play"></i>
      </div>
    </ng-template>
  </div>

  <div class="song-text">
    <strong class="song-title text-truncate">{{ playlist.name }}</strong>
    <span class="song-artist text-truncate">{{ playlist.description }}</span>
    <small class="song-genre">{{ getSongCount(playlist) }}</small>
  </div>
</div>
  </div>

</div>
  <!-- Empty -->
  <div *ngIf="!loading() && !error() && playlists().length === 0" class="alert alert-info mt-3">
    No se pudieron generar playlists automáticas.
  </div>
</section>

<!-- Vista detallada de playlist (superpuesta) -->
<section class="playlist-detail-section" *ngIf="showPlaylistDetail() && selectedPlaylist()">
 <!-- Playlists por género (estilo circular tipo recomendaciones) -->
<div *ngIf="!loading() && !error() && playlists().length > 0" class="recommendations-section">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h3 class="h4 fw-bold mb-0 text-light">Playlists automáticas por género</h3>
    </div>
    <!-- Flechas -->
    <div class="d-flex gap-2">
      <button class="nav-arrow" (click)="scrollLeft()" [disabled]="!canScrollLeft()" title="Anterior">
        <i class="bi bi-chevron-left"></i>
      </button>
      <button class="nav-arrow" (click)="scrollRight()" [disabled]="!canScrollRight()" title="Siguiente">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </div>

  <!-- Carrusel circular -->
  <div class="circular-recommendations" #scrollContainer (scroll)="onScroll()">
    <div *ngFor="let playlist of getCurrentPlaylists()" class="song-circle" (click)="openPlaylist(playlist)">
      <div class="image-container">
        <ng-container *ngIf="getCoverImage(playlist); else fallback">
          <img
            [src]="(getCoverImage(playlist) | mediaUrl) + bust(playlist.songs[0]?.id || 0)"
            [alt]="playlist.name"
            class="circle-image"
            loading="lazy"
            (error)="playlist.songs[0] && onImgError($event, playlist.songs[0])"
          />
        </ng-container>
        <ng-template #fallback>
          <div class="image-fallback">
            <i class="bi bi-collection-play"></i>
          </div>
        </ng-template>
      </div>

      <div class="song-text">
        <strong class="song-title text-truncate">{{ playlist.name }}</strong>
        <span class="song-artist text-truncate">{{ playlist.description }}</span>
        <small class="song-genre">{{ getSongCount(playlist) }}</small>
      </div>
    </div>
  </div>
</div>



  <div class="playlist-tracks-container">
    <div class="tracks-header">
      <span class="track-number">#</span>
      <span class="track-title-header">Título</span>
      <span class="track-album">Álbum</span>
      <span class="track-duration">Duración</span>
    </div>

    <div class="tracks-list">
      <!-- Mostrar TODAS las canciones directamente -->
      <div class="track-item" 
           *ngFor="let song of selectedPlaylist()!.songs; let i = index"
           (click)="playSong(song, $event)">
        <div class="track-number">
          <span class="track-index">{{ i + 1 }}</span>
          <button class="track-play-btn" (click)="playSong(song, $event)">
            <i class="bi bi-play-fill"></i>
          </button>
        </div>
        
        <div class="track-info">
          <div class="track-cover-small">
            <img
              [src]="(song.art_work_song | mediaUrl) + bust(song.id)"
              [alt]="song.name_song"
              class="cover-img-small"
              (error)="onImgError($event, song)"
            />
            <div class="cover-fallback-small" *ngIf="noImg.has(song.id)">
              <i class="bi bi-music-note-beamed"></i>
            </div>
          </div>
          
          <div class="track-details">
            <span class="track-name">{{ song.name_song }}</span>
            <span class="track-artist">{{ song.artist_song }}</span>
          </div>
        </div>
        
        <div class="track-album">
          {{ song.album_song }}
        </div>
        
        <div class="track-duration">
          {{ formatDuration(180) }}
        </div>
      </div>
    </div>
  </div>
</section>