<!-- Vista principal de playlists (siempre presente, pero oculta cuando hay detalle) -->
<section class="auto-playlists-section" [class.d-none]="showPlaylistDetail()">
  
  <!-- Loader -->
  <div *ngIf="loading()" class="row g-4">
    <div class="col-6 col-md-4 col-lg-3 col-xl-2" *ngFor="let _ of [0,1,2,3,4,5,6,7]">
      <div class="playlist-card">
        <div class="sk-cover-square mb-3"></div>
        <div class="placeholder-glow mb-2">
          <span class="placeholder col-10"></span>
        </div>
        <div class="placeholder-glow">
          <span class="placeholder col-7"></span>
        </div>
      </div>
    </div>
  </div>

  <!-- Error -->
  <div *ngIf="!loading() && error()" class="alert alert-danger mt-3">
    {{ error() }}
  </div>

  <!-- Mix Popular (mismo formato que Recent Track) -->
  <div *ngIf="!loading() && popularPlaylist() !== undefined" class="mb-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h3 class="h4 fw-bold mb-0">Mix de Populares</h3>
        <p class="text-muted mb-0">Las canciones más populares</p>
      </div>
      <div class="d-flex gap-2">
        <!-- Botón para guardar playlist completa -->
        <button class="round-btn" 
                (click)="savePopularPlaylist()" 
                [disabled]="isPopularPlaylistSaved() || savingPopularPlaylist()"
                [title]="isPopularPlaylistSaved() ? 'Ya guardada' : 'Guardar playlist completa'">
          <i class="bi" 
            [class]="getSavePopularButtonIcon()"
            [class.loading]="savingPopularPlaylist()"></i>
        </button>
        
        <button class="round-btn" (click)="playPopularPlaylist()" title="Reproducir todo">
          <i class="bi bi-play-fill"></i>
        </button>
        <button class="round-btn" 
                (click)="prevPopularPage()" 
                [disabled]="!canGoPrevPopular()" 
                title="Anterior">
          <i class="bi bi-chevron-left"></i>
        </button>
        <button class="round-btn" 
                (click)="nextPopularPage()" 
                [disabled]="!canGoNextPopular()" 
                title="Siguiente">
          <i class="bi bi-chevron-right"></i>
        </button>
      </div>
    </div>

    <!-- Grid 3 columnas igual que Recent Track -->
    <div *ngIf="!loading() && !error() && getCurrentPopularSongs().length > 0" class="row g-4">
      <div class="col-12 col-md-6 col-lg-4" *ngFor="let col of getPopularColumns()">
        <ul class="list-group list-group-flush">
          <li class="list-group-item bg-transparent px-0" *ngFor="let song of col">
            <div class="d-flex align-items-center gap-3 popular-item"
                (click)="playSong(song, $event)" role="button">

              <!-- Cover con overlay -->
              <div class="cover-wrap">
                <ng-container *ngIf="!noImg.has(song.id); else iconFallback">
                  <img
                    [src]="(song.art_work_song | mediaUrl) + bust(song.id)"
                    [alt]="song.name_song"
                    width="56" height="56"
                    class="cover-img"
                    loading="lazy"
                    (error)="onImgError($event, song)"
                  />
                </ng-container>

                <ng-template #iconFallback>
                  <div class="cover-fallback">
                    <i class="bi bi-music-note-beamed"></i>
                  </div>
                </ng-template>

                <!-- overlay: solo Play -->
                <button class="overlay-btn play"
                        (click)="$event.stopPropagation(); playSong(song, $event)"
                        title="Reproducir">
                  <i class="bi bi-play-fill"></i>
                </button>
              </div>

              <!-- Texto - igual que Recent Track -->
              <div class="flex-grow-1 overflow-hidden minw0">
                <span class="track-title text-truncate" [title]="song.name_song">
                  {{ song.name_song }}
                </span>
                <div class="track-meta text-truncate" 
                    [title]="song.artist_song + (song.album_song ? ' • ' + song.album_song : '')">
                  {{ song.artist_song }}<span *ngIf="song.album_song"> • {{ song.album_song }}</span>
                </div>
              </div>

              <!-- Acciones al extremo derecho - NUEVO: Botón + para agregar a playlist -->
              <div class="end-actions">
                <button class="icon-btn"
                        (click)="$event.stopPropagation(); openAddToPlaylist(song)"
                        title="Agregar a playlist">
                  <i class="bi bi-plus-lg"></i>
                </button>
              </div>

            </div>
          </li>
        </ul>
      </div>
    </div>

    <!-- Indicador de paginación -->
    <div class="d-flex justify-content-between align-items-center mt-3">
      
      <div class="d-flex gap-2 d-md-none">
        <button class="round-btn" 
                [disabled]="!canGoPrevPopular()" 
                (click)="prevPopularPage()" 
                title="Anterior">
          <i class="bi bi-chevron-left"></i>
        </button>
        <button class="round-btn" 
                [disabled]="!canGoNextPopular()" 
                (click)="nextPopularPage()" 
                title="Siguiente">
          <i class="bi bi-chevron-right"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Playlists por género (estilo circular tipo recomendaciones) -->
  <div *ngIf="!loading() && !error() && playlists().length > 0" class="recommendations-section mb-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h3 class="h4 fw-bold mb-0 text-light">Playlists automáticas por género</h3>
      </div>
      <!-- Flechas -->
      <div class="d-flex gap-2">
        <button class="nav-arrow" (click)="scrollLeft()" [disabled]="!canScrollLeft()" title="Anterior">
          <i class="bi bi-chevron-left"></i>
        </button>
        <button class="nav-arrow" (click)="scrollRight()" [disabled]="!canScrollRight()" title="Siguiente">
          <i class="bi bi-chevron-right"></i>
        </button>
      </div>
    </div>

    <!-- Carrusel circular -->
    <div class="circular-recommendations" #scrollContainer (scroll)="onScroll()">
      <div *ngFor="let playlist of getCurrentPlaylists()" class="song-circle" (click)="openPlaylist(playlist)">
        <div class="image-container">
          <ng-container *ngIf="getCoverImage(playlist); else fallback">
            <img
              [src]="(getCoverImage(playlist) | mediaUrl) + bust(playlist.songs[0]?.id || 0)"
              [alt]="playlist.name"
              class="circle-image"
              loading="lazy"
              (error)="playlist.songs[0] && onImgError($event, playlist.songs[0])"
            />
          </ng-container>
          <ng-template #fallback>
            <div class="image-fallback">
              <i class="bi bi-collection-play"></i>
            </div>
          </ng-template>
        </div>

        <div class="song-text">
          <strong class="song-title text-truncate">{{ playlist.name }}</strong>
          <span class="song-artist text-truncate">{{ playlist.description }}</span>
          <small class="song-genre">{{ getSongCount(playlist) }}</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Empty -->
  <div *ngIf="!loading() && !error() && playlists().length === 0" class="alert alert-info mt-3">
    No se pudieron generar playlists automáticas.
  </div>
</section>

<!-- Vista detallada de playlist automática -->
<section class="playlist-detail-section" *ngIf="showPlaylistDetail() && selectedPlaylist()">
  
  <!-- Header de playlist detallada -->
  <div class="playlist-detail-header">
    <button class="back-btn" (click)="closePlaylist()" title="Volver a playlists">
      <i class="bi bi-arrow-left"></i>
    </button>
    
    <div class="playlist-header-content">
      <div class="playlist-cover-large">
        <ng-container *ngIf="getCoverImage(selectedPlaylist()!); else fallbackLarge">
          <img
            [src]="(getCoverImage(selectedPlaylist()!) | mediaUrl) + bust(selectedPlaylist()!.songs[0]?.id || 0)"
            [alt]="selectedPlaylist()!.name"
            class="cover-img-large"
            loading="lazy"
            (error)="selectedPlaylist()!.songs[0] && onImgError($event, selectedPlaylist()!.songs[0])"
          />
        </ng-container>
        <ng-template #fallbackLarge>
          <div class="cover-fallback-large">
            <i class="bi bi-collection-play"></i>
          </div>
        </ng-template>
      </div>
      
      <div class="playlist-header-info">
        <h1 class="playlist-detail-title">{{ selectedPlaylist()!.name }}</h1>
        <p class="playlist-detail-meta">
          {{ getSongCount(selectedPlaylist()!) }} • 
          Playlist automática • 
          Generada por IA
        </p>
        
        <div class="playlist-header-actions">
          <button class="play-all-btn" (click)="playPlaylist(selectedPlaylist())">
            <i class="bi bi-play-fill"></i> Reproducir
          </button>
          <button class="save-playlist-btn" 
                  (click)="saveAutoPlaylist(selectedPlaylist()!)"
                  [disabled]="isPlaylistSaved(selectedPlaylist()!) || savingPlaylist()"
                  [title]="isPlaylistSaved(selectedPlaylist()!) ? 'Ya guardada' : 'Guardar esta playlist'">
            <i class="bi" 
               [class.bi-check-lg]="isPlaylistSaved(selectedPlaylist()!)"
               [class.bi-plus-lg]="!isPlaylistSaved(selectedPlaylist()!)"
               [class.loading]="savingPlaylist()"></i>
            {{ isPlaylistSaved(selectedPlaylist()!) ? 'Guardada' : 'Guardar' }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Lista de canciones -->
  <div class="playlist-tracks-container" *ngIf="selectedPlaylist()!.songs && selectedPlaylist()!.songs.length > 0">
    <div class="tracks-header">
      <div class="track-number">#</div>
      <div class="track-title">Título</div>
      <div class="track-album">Álbum</div>
      <div class="track-duration">
        <i class="bi bi-clock"></i>
      </div>
    </div>
    
    <div class="tracks-list">
      <div *ngFor="let song of selectedPlaylist()!.songs; let i = index" 
           class="track-item"
           (click)="playSong(song, $event)">
        
        <div class="track-number">
          <span class="track-index">{{ i + 1 }}</span>
          <button class="track-play-btn">
            <i class="bi bi-play-fill"></i>
          </button>
        </div>
        
        <div class="track-info">
          <div class="track-cover-small">
            <ng-container *ngIf="!noImg.has(song.id); else iconFallbackSmall">
              <img
                [src]="(song.art_work_song | mediaUrl) + bust(song.id)"
                [alt]="song.name_song"
                class="cover-img-small"
                loading="lazy"
                (error)="onImgError($event, song)"
              />
            </ng-container>
            <ng-template #iconFallbackSmall>
              <div class="cover-fallback-small">
                <i class="bi bi-music-note-beamed"></i>
              </div>
            </ng-template>
          </div>
          
          <div class="track-details">
            <div class="track-name">{{ song.name_song }}</div>
            <div class="track-artist">{{ song.artist_song }}</div>
          </div>
        </div>
        
        <div class="track-album">{{ song.album_song || 'Sin álbum' }}</div>
        <div class="track-duration">{{ formatDuration(song.duration) }}</div>
      </div>
    </div>

    <!-- Indicador de más canciones (si hay muchas) -->
    <div *ngIf="selectedPlaylist()!.songs.length > 8" class="more-tracks-indicator">
      <div class="more-tracks-content">
        <i class="bi bi-chevron-down"></i>
        <span class="more-tracks-text">Más canciones</span>
        <i class="bi bi-chevron-down"></i>
      </div>
      <div class="scroll-hint">Desplázate para ver más</div>
    </div>
  </div>

  <!-- Empty State para vista detallada -->
  <div *ngIf="selectedPlaylist()!.songs && selectedPlaylist()!.songs.length === 0" class="empty-tracks text-center py-5">
    <div class="cover-fallback-large mx-auto mb-4" style="width: 120px; height: 120px;">
      <i class="bi bi-collection-play"></i>
    </div>
    <h4 class="playlist-title mb-2">Playlist vacía</h4>
    <p class="playlist-meta mb-4">Esta playlist automática no tiene canciones disponibles.</p>
  </div>

  

</section>