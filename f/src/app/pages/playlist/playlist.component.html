<!-- Vista principal de playlists -->
<section class="playlists-section">
  <div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h1 class="h2 fw-bold mb-1">Tus Playlists</h1>
        <p class="text-muted mb-0">Gestiona tus listas de reproducción</p>
      </div>
      <div class="d-flex gap-2">
        <!-- Botón para crear nueva playlist -->
        <button class="round-btn" (click)="openCreatePlaylistModal()" title="Crear nueva playlist">
          <i class="bi bi-plus-lg"></i>
        </button>
        <button class="round-btn" (click)="loadPlaylists()" title="Actualizar playlists">
          <i class="bi bi-arrow-clockwise"></i>
        </button>
      </div>
    </div>

    <!-- Loader -->
    <div *ngIf="loading()" class="row g-4">
      <div class="col-6 col-md-4 col-lg-3 col-xl-2" *ngFor="let _ of [0,1,2,3,4,5]">
        <div class="playlist-card">
          <div class="sk-cover-square mb-3"></div>
          <div class="placeholder-glow mb-2">
            <span class="placeholder col-10"></span>
          </div>
          <div class="placeholder-glow">
            <span class="placeholder col-7"></span>
          </div>
        </div>
      </div>
    </div>

    <!-- Error -->
    <div *ngIf="!loading() && error()" class="alert alert-danger mt-3">
      {{ error() }}
      <button class="btn btn-sm btn-outline-danger ms-2" (click)="loadPlaylists()">Reintentar</button>
    </div>

    <!-- Lista de Playlists -->
    <div *ngIf="!loading() && !error() && playlists().length > 0" class="row g-4">
      <div class="col-6 col-md-4 col-lg-3 col-xl-2" *ngFor="let playlist of playlists()">
        <div class="playlist-card" (click)="openPlaylistModal(playlist)">
          <div class="cover-wrap-square">
            <ng-container *ngIf="getPlaylistCover(playlist) && playlist.songs && playlist.songs.length > 0; else iconFallback">
              <img
                [src]="(getPlaylistCover(playlist) | mediaUrl) + bust(playlist.songs[0]?.id || 0)"
                [alt]="playlist.name_playlist"
                class="cover-img-square"
                loading="lazy"
                (error)="playlist.songs[0] && onImgError($event, playlist.songs[0])"
              />
            </ng-container>

            <ng-template #iconFallback>
              <div class="cover-fallback-square">
                <i class="bi bi-collection-play"></i>
              </div>
            </ng-template>

            <div class="playlist-overlay">
              <button class="overlay-btn-square play" 
                      (click)="$event.stopPropagation()" 
                      title="Reproducir playlist">
                <i class="bi bi-play-fill"></i>
              </button>
              <button class="overlay-btn-square delete" 
                      (click)="deletePlaylist(playlist, $event)" 
                      title="Eliminar playlist">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </div>

          <div class="playlist-card-info">
            <h3 class="playlist-title text-truncate" [title]="playlist.name_playlist">
              {{ playlist.name_playlist }}
            </h3>
            <p class="playlist-desc text-truncate">
              {{ playlist.is_public ? 'Pública' : 'Privada' }}
            </p>
            <p class="playlist-meta">
              {{ getSongCount(playlist) }}
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Empty State -->
    <div *ngIf="!loading() && !error() && playlists().length === 0" class="text-center py-5">
      <div class="empty-state">
        <i class="bi bi-collection-play display-1 text-muted mb-3"></i>
        <h3 class="h4 text-muted mb-2">No tienes playlists</h3>
        <p class="text-muted mb-4">Crea tu primera playlist desde la sección de Mixes Automáticos</p>
        <div class="d-flex gap-3 justify-content-center">
          <button class="btn btn-primary" routerLink="/dashboard">
            <i class="bi bi-music-note-list me-2"></i>
            Explorar Mixes
          </button>
          <button class="btn btn-outline-primary" (click)="openCreatePlaylistModal()">
            <i class="bi bi-plus-circle me-2"></i>
            Crear Nueva Playlist
          </button>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Modal para crear nueva playlist -->
<div class="modal-backdrop fade show" *ngIf="showCreatePlaylistModal()"></div>

<div class="modal fade show d-block" 
     *ngIf="showCreatePlaylistModal()" 
     tabindex="-1"
     aria-modal="true"
     role="dialog">
  <div class="modal-dialog modal-md modal-dialog-centered">
    <div class="modal-content create-playlist-modal-content">
      
      <!-- Header del Modal -->
      <div class="modal-header create-playlist-modal-header">
        <h2 class="modal-title">Crear Nueva Playlist</h2>
        <button type="button" class="btn-close btn-close-white" 
                (click)="closeCreatePlaylistModal()" 
                [disabled]="creatingNewPlaylist()"
                aria-label="Close"></button>
      </div>

      <!-- Formulario -->
      <div class="modal-body create-playlist-modal-body">
        <form (ngSubmit)="createNewPlaylist()">
          <!-- Nombre de la playlist -->
          <div class="mb-4">
            <label for="playlistName" class="form-label">Nombre de la playlist</label>
            <input type="text" 
                   class="form-control custom-input" 
                   id="playlistName"
                   [(ngModel)]="newPlaylistName" 
                   name="playlistName"
                   placeholder="Mi playlist favorita"
                   required
                   [disabled]="creatingNewPlaylist()">
            <div class="form-text">Elige un nombre único para tu playlist</div>
          </div>

          <!-- Visibilidad -->
          <div class="mb-4">
            <label class="form-label">Visibilidad</label>
            <div class="visibility-options">
              <div class="form-check">
                <input class="form-check-input" 
                       type="radio" 
                       id="publicPlaylist"
                       [(ngModel)]="newPlaylistIsPublic" 
                       name="playlistVisibility"
                       [value]="true"
                       [disabled]="creatingNewPlaylist()">
                <label class="form-check-label" for="publicPlaylist">
                  <i class="bi bi-globe me-2"></i>
                  Pública
                  <small class="d-block text-muted">Cualquier usuario puede ver esta playlist</small>
                </label>
              </div>
              <div class="form-check mt-2">
                <input class="form-check-input" 
                       type="radio" 
                       id="privatePlaylist"
                       [(ngModel)]="newPlaylistIsPublic" 
                       name="playlistVisibility"
                       [value]="false"
                       [disabled]="creatingNewPlaylist()">
                <label class="form-check-label" for="privatePlaylist">
                  <i class="bi bi-lock me-2"></i>
                  Privada
                  <small class="d-block text-muted">Solo tú puedes ver esta playlist</small>
                </label>
              </div>
            </div>
          </div>

          <!-- Botones -->
          <div class="create-playlist-actions">
            <button type="button" 
                    class="btn btn-outline-secondary" 
                    (click)="closeCreatePlaylistModal()"
                    [disabled]="creatingNewPlaylist()">
              Cancelar
            </button>
            <button type="submit" 
                    class="btn btn-primary"
                    [disabled]="!newPlaylistName().trim() || creatingNewPlaylist()">
              <span *ngIf="creatingNewPlaylist()" class="spinner-border spinner-border-sm me-2"></span>
              <i class="bi" [class.bi-plus-circle]="!creatingNewPlaylist()" [class.bi-arrow-repeat]="creatingNewPlaylist()"></i>
              {{ creatingNewPlaylist() ? 'Creando...' : 'Crear Playlist' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Modal de canciones de la playlist -->
<div class="modal-backdrop fade show" *ngIf="showPlaylistModal() && selectedPlaylist()"></div>

<div class="modal fade show d-block" 
     *ngIf="showPlaylistModal() && selectedPlaylist()" 
     tabindex="-1"
     aria-modal="true"
     role="dialog">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content create-playlist-modal-content"> <!-- Cambiado a create-playlist-modal-content -->
      
      <!-- Header del Modal -->
      <div class="modal-header create-playlist-modal-header"> <!-- Cambiado a create-playlist-modal-header -->
        <div class="modal-header-content">
          <div class="playlist-cover-modal">
            <ng-container *ngIf="getPlaylistCover(selectedPlaylist()!); else modalIconFallback">
              <img
                [src]="(getPlaylistCover(selectedPlaylist()!) | mediaUrl) + bust(selectedPlaylist()!.songs[0]?.id || 0)"
                [alt]="selectedPlaylist()!.name_playlist"
                class="cover-img-modal"
                (error)="selectedPlaylist()!.songs[0] && onImgError($event, selectedPlaylist()!.songs[0])"
              />
            </ng-container>

            <ng-template #modalIconFallback>
              <div class="cover-fallback-modal">
                <i class="bi bi-collection-play"></i>
              </div>
            </ng-template>
          </div>
          
          <div class="playlist-info-modal">
            <h2 class="playlist-modal-title" style="color: #ffffff !important;">{{ selectedPlaylist()!.name_playlist }}</h2>
            <p class="playlist-modal-desc" style="color: #f8f9fa !important;">
              {{ selectedPlaylist()!.is_public ? 'Playlist pública' : 'Playlist privada' }}
            </p>
            <p class="playlist-modal-meta" style="color: #e9ecef !important;">
              {{ getSongCount(selectedPlaylist()!) }} • 
              Creada el {{ selectedPlaylist()!.created_at | date:'dd/MM/yyyy' }}
            </p>
            
            <div class="playlist-modal-actions">
              <button class="play-all-btn">
                <i class="bi bi-play-fill"></i>
                Reproducir
              </button>
              <button class="btn-outline" (click)="deletePlaylist(selectedPlaylist()!, $event)">
                <i class="bi bi-trash"></i>
                Eliminar
              </button>
            </div>
          </div>
        </div>
        
        <button type="button" class="btn-close btn-close-white" (click)="closePlaylistModal()" aria-label="Close"></button>
      </div>

      <!-- Lista de canciones -->
      <div class="modal-body create-playlist-modal-body"> <!-- Cambiado a create-playlist-modal-body -->
        <div class="tracks-container">
          <div class="tracks-header" style="color: #e9ecef !important;">
            <span class="track-number">#</span>
            <span class="track-title-header">Título</span>
            <span class="track-album">Álbum</span>
            <span class="track-duration">Duración</span>
          </div>

          <div class="tracks-list">
            <div class="track-item" 
                *ngFor="let savedSong of selectedPlaylist()!.songs; let i = index">
              <div class="track-number">
                <span class="track-index" style="color: #e9ecef !important;">{{ i + 1 }}</span>
                <button class="track-play-btn">
                  <i class="bi bi-play-fill"></i>
                </button>
              </div>
              
              <div class="track-info">
                <div class="track-cover-small">
                  <img
                    [src]="(savedSong.song?.art_work_song | mediaUrl) + bust(savedSong.song?.id || 0)"
                    [alt]="savedSong.song?.name_song"
                    class="cover-img-small"
                    (error)="onImgError($event, savedSong.song)"
                  />
                  <div class="cover-fallback-small" *ngIf="savedSong.song && noImg.has(savedSong.song.id)">
                    <i class="bi bi-music-note-beamed"></i>
                  </div>
                </div>
                
                <div class="track-details">
                  <span class="track-name" style="color: #ffffff !important;">{{ savedSong.song?.name_song }}</span>
                  <span class="track-artist" style="color: #e9ecef !important;">{{ savedSong.song?.artist_song }}</span>
                </div>
              </div>
              
              <div class="track-album" style="color: #e9ecef !important;">
                {{ savedSong.song?.album_song || 'Sin álbum' }}
              </div>
              
              <div class="track-duration" style="color: #e9ecef !important;">
                {{ formatDuration(savedSong.song?.duration || 180) }}
              </div>
            </div>
          </div>

          <!-- Empty state para playlist sin canciones -->
          <div *ngIf="!selectedPlaylist()!.songs || selectedPlaylist()!.songs.length === 0" 
               class="empty-tracks text-center py-5">
            <i class="bi bi-music-note-beamed display-4 mb-3" style="color: #dee2e6 !important;"></i>
            <h4 class="mb-2" style="color: #ffffff !important;">No hay canciones</h4>
            <p style="color: #e9ecef !important;">Esta playlist no tiene canciones aún</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>