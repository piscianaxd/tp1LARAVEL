<!-- Contenido principal de playlists -->
<div class="auto-playlists-section mb-5">
  
  <!-- Vista Principal de Playlists -->
  <div *ngIf="!showPlaylistDetail()" class="mb-5">
    
    <!-- Header de la Sección MODIFICADO -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h2 class="playlist-title mb-1">Tus Playlists</h2>
        <p class="playlist-meta">Gestiona y organiza tu música</p>
      </div>
      <!-- NUEVO: Flechas al lado del botón crear -->
      <div class="d-flex gap-2 align-items-center">
        <!-- Botón crear playlist -->
        <button class="round-btn" (click)="openCreatePlaylistModal()" title="Crear nueva playlist">
          <i class="bi bi-plus-lg"></i>
        </button>
        <!-- Flechas de paginación -->
        <button class="round-btn" 
                (click)="prevPage()" 
                [disabled]="!canGoPrev()" 
                title="Página anterior">
          <i class="bi bi-chevron-left"></i>
        </button>
        <button class="round-btn" 
                (click)="nextPage()" 
                [disabled]="!canGoNext()" 
                title="Página siguiente">
          <i class="bi bi-chevron-right"></i>
        </button>
      </div>
    </div>

    <!-- Indicador de actualización -->
    <div *ngIf="loading() && playlists().length > 0" class="updating-indicator">
      <div class="spinner-border spinner-border-sm text-brand me-2"></div>
      <span class="playlist-meta">Actualizando playlists...</span>
    </div>

    <!-- Loading State -->
    <div *ngIf="loading() && playlists().length === 0" class="text-center py-5">
      <div class="spinner-border text-brand" role="status">
        <span class="visually-hidden">Cargando...</span>
      </div>
      <p class="playlist-meta mt-3">Cargando tus playlists...</p>
    </div>

    <!-- Error State -->
    <div *ngIf="error() && !loading()" class="alert alert-warning text-center">
      <i class="bi bi-exclamation-triangle me-2"></i>
      <span>{{ error() }}</span>
      <button class="btn btn-outline-warning btn-sm ms-3" (click)="loadPlaylists()">
        <i class="bi bi-arrow-clockwise"></i> Reintentar
      </button>
    </div>

    <!-- Playlists Grid -->
    <div *ngIf="!loading() && !error() && playlists().length > 0" class="row g-4">
      <!-- ELIMINADO: Contenedor de paginación que estaba aquí -->

      <!-- NUEVO: Cambiar playlists() por getCurrentPlaylists() -->
      <div *ngFor="let playlist of getCurrentPlaylists()" 
           class="col-6 col-md-4 col-lg-3 col-xl-2">
        
        <div class="playlist-card" (click)="openPlaylist(playlist)">
          
          <div class="cover-wrap-square">
            <img *ngIf="getPlaylistCover(playlist)" 
                 [src]="getPlaylistCover(playlist) | mediaUrl" 
                 [alt]="playlist.name_playlist"
                 class="cover-img-square"
                 (error)="onImgError($event, playlist.songs[0]?.song)">
            <div *ngIf="!getPlaylistCover(playlist)" class="cover-fallback-square">
              <i class="bi bi-music-note-list"></i>
            </div>
            
            <div class="playlist-overlay">
              <button class="overlay-btn-square play" 
                      (click)="playPlaylist(playlist, $event)"
                      title="Reproducir playlist">
                <i class="bi bi-play-fill"></i>
              </button>
              <button class="overlay-btn-square" 
                      (click)="deletePlaylist(playlist, $event)"
                      title="Eliminar playlist">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </div>

          <div class="playlist-card-info">
            <h3 class="playlist-title">{{ playlist.name_playlist }}</h3>
            <p class="playlist-meta">{{ getSongCount(playlist) }}</p>
            <span class="playlist-meta">
              <i class="bi" [class.bi-globe]="playlist.is_public" [class.bi-lock]="!playlist.is_public"></i>
              {{ playlist.is_public ? 'Pública' : 'Privada' }}
            </span>
          </div>

        </div>
      </div>
    </div>

    <!-- Empty State -->
    <div *ngIf="!loading() && !error() && playlists().length === 0" class="text-center py-5">
      <div class="cover-fallback-square mx-auto mb-3" style="width: 120px; height: 120px;">
        <i class="bi bi-music-note-list"></i>
      </div>
      <h4 class="playlist-title mb-2">No tienes playlists aún</h4>
      <p class="playlist-meta mb-4">Crea tu primera playlist para organizar tu música favorita</p>
      <button class="round-btn" (click)="openCreatePlaylistModal()" title="Crear primera playlist">
        <i class="bi bi-plus-lg"></i>
      </button>
    </div>

  </div>

  <!-- Vista Detallada de Playlist -->
  <div *ngIf="showPlaylistDetail() && selectedPlaylist()" class="playlist-detail-section">
    
    <!-- Header de playlist detallada -->
    <div class="playlist-detail-header">
      <button class="back-btn" (click)="closePlaylist()" title="Volver a playlists">
        <i class="bi bi-arrow-left"></i>
      </button>
      
      <div class="playlist-header-content">
        <div class="playlist-cover-large">
          <img *ngIf="getPlaylistCover(selectedPlaylist()!)" 
               [src]="getPlaylistCover(selectedPlaylist()!) | mediaUrl" 
               [alt]="selectedPlaylist()!.name_playlist"
               class="cover-img-large">
          <div *ngIf="!getPlaylistCover(selectedPlaylist()!)" class="cover-fallback-large">
            <i class="bi bi-music-note-list"></i>
          </div>
        </div>
        
        <div class="playlist-header-info">
          <h1 class="playlist-detail-title">{{ selectedPlaylist()!.name_playlist }}</h1>
          <p class="playlist-detail-meta">
            {{ getSongCount(selectedPlaylist()!) }} • 
            {{ selectedPlaylist()!.is_public ? 'Pública' : 'Privada' }} • 
            Creada el {{ selectedPlaylist()!.created_at | date:'mediumDate' }}
          </p>
          
          <div class="playlist-header-actions">
            <button class="play-all-btn" (click)="playPlaylist(selectedPlaylist()!, $event)">
              <i class="bi bi-play-fill"></i> Reproducir
            </button>
            <button class="save-playlist-btn" (click)="openEditPlaylistModal(selectedPlaylist()!, $event)">
              <i class="bi bi-pencil"></i> Editar
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Lista de canciones -->
    <div class="playlist-tracks-container" *ngIf="selectedPlaylist()!.songs && selectedPlaylist()!.songs.length > 0">
      <div class="tracks-header">
        <div class="track-number">#</div>
        <div class="track-title">Título</div>
        <div class="track-album">Álbum</div>
        <div class="track-duration">
          <i class="bi bi-clock"></i>
        </div>
      </div>
      
      <!-- NUEVO: Agregado contextmenu a cada track -->
      <div *ngFor="let playlistSong of selectedPlaylist()!.songs; let i = index" 
           class="track-item"
           (click)="playSong(playlistSong.song, $event)"
           (contextmenu)="onTrackContextMenu($event, playlistSong, i)">
        
        <div class="track-number">
          <span class="track-index">{{ i + 1 }}</span>
          <button class="track-play-btn">
            <i class="bi bi-play-fill"></i>
          </button>
        </div>
        
        <div class="track-info">
          <div class="track-cover-small">
            <img *ngIf="playlistSong.song?.art_work_song" 
                 [src]="playlistSong.song.art_work_song | mediaUrl" 
                 [alt]="playlistSong.song.name_song"
                 class="cover-img-small"
                 (error)="onImgError($event, playlistSong.song)">
            <div *ngIf="!playlistSong.song?.art_work_song" class="cover-fallback-small">
              <i class="bi bi-music-note-beamed"></i>
            </div>
          </div>
          <div class="track-details">
            <div class="track-name">{{ playlistSong.song?.name_song || 'Canción desconocida' }}</div>
            <div class="track-artist">{{ playlistSong.song?.artist_song || 'Artista desconocido' }}</div>
          </div>
        </div>
        
        <div class="track-album">{{ playlistSong.song?.album_song || 'Álbum desconocido' }}</div>
        <div class="track-duration">{{ formatDuration(playlistSong.song?.duration) }}</div>
      </div>

      <!-- Indicador de más canciones (si hay muchas) -->
      <div *ngIf="selectedPlaylist()!.songs.length > 8" class="more-tracks-indicator">
        <div class="more-tracks-content">
          <i class="bi bi-chevron-down"></i>
          <span class="more-tracks-text">Más canciones</span>
          <i class="bi bi-chevron-down"></i>
        </div>
        <div class="scroll-hint">Desplázate para ver más</div>
      </div>
    </div>

    <!-- Empty State para vista detallada -->
    <div *ngIf="selectedPlaylist()!.songs && selectedPlaylist()!.songs.length === 0" class="empty-tracks">
      <div class="cover-fallback-large mx-auto mb-4" style="width: 120px; height: 120px;">
        <i class="bi bi-music-note-list"></i>
      </div>
      <h4 class="playlist-title mb-2">Playlist vacía</h4>
      <p class="playlist-meta mb-4">Esta playlist no tiene canciones aún.</p>
      <button class="round-btn" title="Agregar canciones">
        <i class="bi bi-plus-lg"></i>
      </button>
    </div>

  </div>

</div>

<!-- NUEVO: Menú contextual para tracks -->
<app-track-context-menu
  [isVisible]="showContextMenu()"
  [position]="contextMenuPosition()"
  [track]="selectedTrackForContextMenu()"
  [menuType]="'playlist'"
  (play)="onContextMenuPlay()"
  (delete)="onContextMenuDelete()"
  (move)="onContextMenuMove()"
  (close)="closeContextMenu()">
</app-track-context-menu>

<!-- NUEVO: Modal para mover a otra playlist -->
<div class="modal-overlay" *ngIf="showMoveToPlaylistModal()" (click)="closeMoveToPlaylistModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    
    <div class="modal-header">
      <h2 class="modal-title">Mover a Otra Playlist</h2>
      <button class="close-btn" (click)="closeMoveToPlaylistModal()" title="Cerrar">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>

    <div class="modal-body">
      <!-- Información de la canción -->
      <div class="song-info" *ngIf="trackBeingMoved">
        <div class="song-cover">
          <img *ngIf="trackBeingMoved.song?.art_work_song" 
              [src]="trackBeingMoved.song.art_work_song | mediaUrl" 
              [alt]="trackBeingMoved.song?.name_song"
              class="cover-img">
          <div *ngIf="!trackBeingMoved.song?.art_work_song" class="cover-fallback">
            <i class="bi bi-music-note-beamed"></i>
          </div>
        </div>
        <div class="song-details">
          <h4 class="song-name">{{ trackBeingMoved.song?.name_song }}</h4>
          <p class="song-artist">{{ trackBeingMoved.song?.artist_song }}</p>
        </div>
      </div>



      <!-- Lista de playlists disponibles -->
      <div class="playlists-section">
        <h5 class="section-title">Selecciona una playlist destino</h5>
        
        <div *ngIf="loadingMoveModal()" class="loading-playlists">
          <div class="spinner-border spinner-border-sm text-brand me-2"></div>
          <span>Cargando playlists...</span>
        </div>

        <!-- Si hay playlists disponibles -->
        <div *ngIf="!loadingMoveModal() && availablePlaylistsForMove().length > 0" class="playlists-list">
          <div *ngFor="let playlist of availablePlaylistsForMove()" 
               class="playlist-item"
               [class.selected]="selectedPlaylistForMove() === playlist.id"
               (click)="selectPlaylistForMove(playlist.id)">
            <div class="playlist-info">
              <i class="bi" 
                 [class.bi-list-ul]="!selectedPlaylistForMove() || selectedPlaylistForMove() !== playlist.id"
                 [class.bi-check-circle-fill]="selectedPlaylistForMove() === playlist.id"></i>
              <span class="playlist-name">{{ playlist.name_playlist }}</span>
            </div>
            <span class="playlist-meta">
              {{ playlist.songs.length || 0 }} canciones • 
              {{ playlist.is_public ? 'Pública' : 'Privada' }}
            </span>
          </div>
        </div>

        <!-- Si NO hay playlists -->
        <div *ngIf="!loadingMoveModal() && availablePlaylistsForMove().length === 0" class="no-playlists text-center py-4">
          <i class="bi bi-music-note-list fs-1 mb-2"></i>
          <p>No tienes playlists creadas</p>
          <small>Crea tu primera playlist para poder mover canciones</small>
          <div class="mt-3">
            <button class="btn btn-primary" (click)="openCreatePlaylistModal(); closeMoveToPlaylistModal()">
              Crear Playlist
            </button>
          </div>
        </div>
      </div>

      <!-- Botón mover (solo si hay playlists) -->
      <div class="mt-3" *ngIf="availablePlaylistsForMove().length > 0">
        <button class="btn btn-primary" 
                (click)="moveTrackToPlaylist()"
                [disabled]="!selectedPlaylistForMove() || movingTrack()">
          <span *ngIf="movingTrack()" class="spinner-border spinner-border-sm me-2"></span>
          <i *ngIf="!movingTrack()" class="bi bi-arrow-right me-2"></i>
          {{ movingTrack() ? 'Moviendo...' : 'Mover a Playlist' }}
        </button>
      </div>

    </div>
  </div>
</div>

<!-- Modal para crear nueva playlist - CON EFECTO DE DESENFOQUE -->
<div class="modal-overlay" *ngIf="showCreatePlaylistModal()" (click)="closeCreatePlaylistModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    
    <!-- Header del Modal -->
    <div class="modal-header">
      <h2 class="modal-title">Crear Nueva Playlist</h2>
      <button class="close-btn" (click)="closeCreatePlaylistModal()" 
              [disabled]="creatingNewPlaylist()"
              title="Cerrar">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>

    <!-- Formulario -->
    <div class="modal-body">
      <form (ngSubmit)="createNewPlaylist()" class="profile-form">
        <!-- Nombre de la playlist -->
        <div class="form-group">
          <label for="playlistName">Nombre de la playlist</label>
          <input type="text" 
                 id="playlistName"
                 class="form-control"
                 [(ngModel)]="newPlaylistName"
                 name="playlistName"
                 placeholder="Mi playlist favorita"
                 required
                 [disabled]="creatingNewPlaylist()">
          <small>Elige un nombre único para tu playlist</small>
        </div>

        <!-- Visibilidad -->
        <div class="form-group">
          <label>Visibilidad</label>
          <div class="visibility-options">
            <div class="form-check">
              <input class="form-check-input" 
                     type="radio" 
                     id="publicPlaylist"
                     [(ngModel)]="newPlaylistIsPublic" 
                     name="playlistVisibility"
                     [value]="true"
                     [disabled]="creatingNewPlaylist()">
              <label class="form-check-label" for="publicPlaylist">
                <i class="bi bi-globe me-2"></i>
                Pública
                <small class="d-block">Cualquier usuario puede ver esta playlist</small>
              </label>
            </div>
            <div class="form-check mt-2">
              <input class="form-check-input" 
                     type="radio" 
                     id="privatePlaylist"
                     [(ngModel)]="newPlaylistIsPublic" 
                     name="playlistVisibility"
                     [value]="false"
                     [disabled]="creatingNewPlaylist()">
              <label class="form-check-label" for="privatePlaylist">
                <i class="bi bi-lock me-2"></i>
                Privada
                <small class="d-block">Solo tú puedes ver esta playlist</small>
              </label>
            </div>
          </div>
        </div>

        <!-- Botones -->
        <div class="form-actions">
          <button type="button" 
                  class="btn btn-outline-secondary" 
                  (click)="closeCreatePlaylistModal()"
                  [disabled]="creatingNewPlaylist()">
            Cancelar
          </button>
          <button type="submit" 
                  class="btn btn-primary"
                  [disabled]="!newPlaylistName.trim() || creatingNewPlaylist()">
            <span *ngIf="creatingNewPlaylist()" class="spinner-border spinner-border-sm me-2"></span>
            <i class="bi" [class.bi-plus-circle]="!creatingNewPlaylist()" [class.bi-arrow-repeat]="creatingNewPlaylist()"></i>
            {{ creatingNewPlaylist() ? 'Creando...' : 'Crear Playlist' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
  <!-- Modal para editar playlist CON LISTA DE CANCIONES -->
<!-- Modal para editar playlist CON NUEVO LAYOUT -->
<div class="modal-overlay" *ngIf="showEditPlaylistModal()" (click)="closeEditPlaylistModal()">
  <div class="modal-content large-modal" (click)="$event.stopPropagation()">
    
    <!-- Header del Modal -->
    <div class="modal-header">
      <h2 class="modal-title">Editar Playlist</h2>
      <button class="close-btn" (click)="closeEditPlaylistModal()" 
              [disabled]="editingPlaylist()"
              title="Cerrar">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>

    <!-- Contenido principal CON NUEVO LAYOUT -->
    <div class="modal-body edit-playlist-modal">

      <!-- FILA 1: Formulario de edición -->
      <div class="edit-playlist-form">
        <form (ngSubmit)="updatePlaylist()" class="profile-form">
          <!-- Nombre de la playlist -->
          <div class="form-group">
            <label for="editPlaylistName">Nombre de la playlist</label>
            <input type="text"
                  id="editPlaylistName"
                  class="form-control"
                  [(ngModel)]="editPlaylistName"
                  name="editPlaylistName"
                  placeholder="Nombre de la playlist"
                  required
                  [disabled]="editingPlaylist()">
          </div>

          <!-- Visibilidad -->
          <div class="form-group">
            <label class="form-label fw-bold">Visibilidad</label>
            <div class="visibility-options-simple">
              <div class="form-check">
                <input class="form-check-input" type="radio" id="editPublicPlaylist" [(ngModel)]="editPlaylistIsPublic" name="editPlaylistVisibility" [value]="true">
                <label class="form-check-label" for="editPublicPlaylist">
                  <div class="label-row"><i class="bi bi-globe"></i><span> Pública</span></div>
                  <small class="d-block text-muted">Todos pueden ver esta playlist</small>
                </label>
              </div>
              <div class="form-check mt-2">
                <input class="form-check-input" type="radio" id="editPrivatePlaylist" [(ngModel)]="editPlaylistIsPublic" name="editPlaylistVisibility" [value]="false">
                <label class="form-check-label" for="editPrivatePlaylist">
                  <div class="label-row"><i class="bi bi-lock"></i><span> Privada</span></div>
                  <small class="d-block text-muted">Solo tú puedes ver esta playlist</small>
                </label>
              </div>
            </div>
          </div>
        </form>
      </div>

      <!-- FILA 2: Lista de canciones -->
      <div class="edit-playlist-songs-list">
        <div class="songs-list-container">
          <div *ngFor="let playlistSong of selectedPlaylist()!.songs; let i = index" class="song-item-editable">

            <span class="song-number">{{ i + 1 }}</span>

            <div class="song-cover-small">
              <img *ngIf="playlistSong.song?.art_work_song && !noImg.has(playlistSong.song.id)"
                  [src]="playlistSong.song.art_work_song | mediaUrl"
                  [alt]="playlistSong.song.name_song"
                  class="cover-img-tiny"
                  (error)="onImgError($event, playlistSong.song)">
              <div *ngIf="!playlistSong.song?.art_work_song || noImg.has(playlistSong.song.id)" class="cover-fallback-tiny">
                <i class="bi bi-music-note-beamed"></i>
              </div>
            </div>

            <div class="song-text-block">
              <div class="song-name" [title]="getSafeSongInfo(playlistSong).name">
                {{ getSafeSongInfo(playlistSong).name }}
              </div>
              <div class="song-artist" [title]="getSafeSongInfo(playlistSong).artist">
                {{ getSafeSongInfo(playlistSong).artist }}
              </div>
              <div class="song-album" [title]="getSafeSongInfo(playlistSong).album">
                {{ getSafeSongInfo(playlistSong).album }}
              </div>
            </div>

            <div class="song-duration">{{ getSafeSongInfo(playlistSong).duration }}</div>

            <div class="song-actions">
              <button class="btn btn-outline-danger btn-sm"
                      (click)="removeTrackFromPlaylistModal(playlistSong)"
                      [disabled]="selectedTrackForDeletion()?.song?.id === playlistSong.song.id"
                      title="Eliminar de la playlist">
                <span *ngIf="selectedTrackForDeletion()?.song?.id === playlistSong.song.id" class="spinner-border spinner-border-sm me-1"></span>
                <i class="bi bi-trash" *ngIf="selectedTrackForDeletion()?.song?.id !== playlistSong.song.id"></i>
                {{ selectedTrackForDeletion()?.song?.id === playlistSong.song.id ? 'Eliminando...' : 'Eliminar' }}
              </button>
            </div>

          </div>
        </div>
      </div>

      <!-- FILA 3: Botones de acción -->
      <!-- Botones en modal de crear playlist -->
      <div class="form-actions">
        <button type="button" 
                class="btn btn-outline-secondary" 
                (click)="closeCreatePlaylistModal()"
                [disabled]="creatingNewPlaylist()">
          Cancelar
        </button>
        <button type="button"
                class="btn btn-primary"
                (click)="updatePlaylist()"
                [disabled]="!editPlaylistName.trim() || editingPlaylist()">
          <span *ngIf="editingPlaylist()" class="spinner-border spinner-border-sm me-2"></span>
          <i class="bi"
            [class.bi-check-circle]="!editingPlaylist()"
            [class.bi-arrow-repeat]="editingPlaylist()"></i>
          {{ editingPlaylist() ? 'Guardando...' : 'Guardar Cambios' }}
        </button>
      </div>
    </div>
  </div>
</div>
  <!-- END: contenido interno reemplazado del modal edit-playlist -->
