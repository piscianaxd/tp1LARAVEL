<div class="modal-overlay" (click)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
        <!-- Header del Modal -->
        <div class="modal-header">
            <h2 class="modal-title">Mi Perfil</h2>
            <button class="close-btn" (click)="closeModal()" title="Cerrar">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>

        <!-- Cargando -->
        <div *ngIf="loading" class="loading">
            <div class="loading-spinner"></div>
            <p>Cargando perfil...</p>
        </div>

        <!-- Contenido del Perfil -->
        <div *ngIf="!loading && user" class="modal-body">
            <!-- Navegación por pestañas -->
            <div class="tab-navigation">
                <button 
                    class="tab-btn" 
                    [class.active]="activeTab === 'profile'"
                    (click)="setActiveTab('profile')">
                    <i class="bi bi-person"></i>
                    Perfil
                </button>
                <button 
                    class="tab-btn" 
                    [class.active]="activeTab === 'security'"
                    (click)="setActiveTab('security')">
                    <i class="bi bi-shield-lock"></i>
                    Seguridad
                </button>
                <button 
                    class="tab-btn" 
                    [class.active]="activeTab === 'logout'"
                    (click)="setActiveTab('logout')">
                    <i class="bi bi-box-arrow-right"></i>
                    Cerrar Sesión
                </button>
            </div>

            <!-- Mensajes generales -->
            <div *ngIf="message" class="alert alert-success">
                <i class="bi bi-check-circle"></i>
                {{ message }}
            </div>

            <div *ngIf="errorMessage" class="alert alert-error">
                <i class="bi bi-exclamation-circle"></i>
                {{ errorMessage }}
            </div>

            <!-- Pestaña: Perfil -->
            <div *ngIf="activeTab === 'profile'" class="tab-content">
                <form [formGroup]="profileForm" (ngSubmit)="updateProfile()" class="profile-form">
                    <div class="form-group">
                        <label for="name">
                            <i class="bi bi-person"></i>
                            Nombre
                        </label>
                        <input type="text" id="name" formControlName="name" class="form-control"
                            [class.error]="pf['name'].invalid && pf['name'].touched" 
                            placeholder="Tu nombre completo"/>
                        <div *ngIf="pf['name'].invalid && pf['name'].touched" class="error-message">
                            <i class="bi bi-exclamation-circle"></i>
                            <div *ngIf="pf['name'].errors?.['required']">El nombre es requerido</div>
                            <div *ngIf="pf['name'].errors?.['minlength']">Mínimo 2 caracteres</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="email">
                            <i class="bi bi-envelope"></i>
                            Email
                        </label>
                        <input type="email" id="email" formControlName="email" class="form-control"
                            [class.error]="pf['email'].invalid && pf['email'].touched"
                            placeholder="tu@email.com"/>
                        <div *ngIf="pf['email'].invalid && pf['email'].touched" class="error-message">
                            <i class="bi bi-exclamation-circle"></i>
                            <div *ngIf="pf['email'].errors?.['required']">El email es requerido</div>
                            <div *ngIf="pf['email'].errors?.['email']">Formato de email inválido</div>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary" [disabled]="saving || profileForm.invalid">
                            <i class="bi bi-check-lg" *ngIf="!saving"></i>
                            <div class="loading-spinner" *ngIf="saving"></div>
                            {{ saving ? "Guardando..." : "Guardar Cambios" }}
                        </button>
                    </div>
                </form>
            </div>

            <!-- Pestaña: Seguridad -->
            <div *ngIf="activeTab === 'security'" class="tab-content">
                <!-- Cambio de Contraseña -->
                <div class="security-section">
                    <h3>
                        <i class="bi bi-key"></i>
                        Cambiar Contraseña
                    </h3>
                    
                    <div *ngIf="passwordMessage" class="alert alert-success">
                        <i class="bi bi-check-circle"></i>
                        {{ passwordMessage }}
                    </div>

                    <div *ngIf="passwordError" class="alert alert-error">
                        <i class="bi bi-exclamation-circle"></i>
                        {{ passwordError }}
                    </div>

                    <form [formGroup]="passwordForm" (ngSubmit)="changePassword()" class="profile-form">
                        <div class="form-group">
                            <label for="current_password">Contraseña Actual</label>
                            <input type="password" id="current_password" formControlName="current_password"
                                class="form-control" 
                                [class.error]="passf['current_password'].invalid && passf['current_password'].touched"
                                placeholder="••••••••"/>
                            <div *ngIf="passf['current_password'].invalid && passf['current_password'].touched" class="error-message">
                                <i class="bi bi-exclamation-circle"></i>
                                La contraseña actual es requerida
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="password">Nueva Contraseña</label>
                            <input type="password" id="password" formControlName="password" class="form-control"
                                [class.error]="passf['password'].invalid && passf['password'].touched"
                                placeholder="••••••••"/>
                            <div *ngIf="passf['password'].invalid && passf['password'].touched" class="error-message">
                                <i class="bi bi-exclamation-circle"></i>
                                <div *ngIf="passf['password'].errors?.['required']">La nueva contraseña es requerida</div>
                                <div *ngIf="passf['password'].errors?.['minlength']">Mínimo 8 caracteres</div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="password_confirmation">Confirmar Contraseña</label>
                            <input type="password" id="password_confirmation" formControlName="password_confirmation"
                                class="form-control"
                                [class.error]="passf['password_confirmation'].invalid && passf['password_confirmation'].touched"
                                placeholder="••••••••"/>
                            <div *ngIf="passf['password_confirmation'].invalid && passf['password_confirmation'].touched" class="error-message">
                                <i class="bi bi-exclamation-circle"></i>
                                La confirmación de contraseña es requerida
                            </div>
                        </div>

                        <div *ngIf="passwordForm.errors?.['passwordMismatch'] && (passf['password'].touched || passf['password_confirmation'].touched)" 
                            class="error-message">
                            <i class="bi bi-exclamation-circle"></i>
                            Las contraseñas no coinciden
                        </div>

                        <button type="submit" class="btn btn-primary change-button" [disabled]="saving">
                            {{ saving ? "Guardando..." : "Cambiar Contraseña" }}
                        </button>
                    </form>
                </div>

                <!-- Eliminar Cuenta -->
                <div class="danger-zone">
                    <h3>
                        <i class="bi bi-trash"></i>
                        ELIMINAR CUENTA
                    </h3>
                    <div class="danger-warning">
                        <i class="bi bi-exclamation-triangle"></i>
                        <span>Esta acción no se puede deshacer</span>
                    </div>

                    <div *ngIf="deleteError" class="alert alert-error">
                        <i class="bi bi-exclamation-circle"></i>
                        {{ deleteError }}
                    </div>

                    <form [formGroup]="deleteForm" (ngSubmit)="deleteAccount()" class="delete-form">
                        <div class="form-group">
                            <label for="deletePassword">Confirmar con contraseña</label>
                            <input type="password" id="deletePassword" formControlName="password" class="form-control"
                                [class.error]="df['password'].invalid && df['password'].touched"
                                placeholder="••••••••"/>
                            <div *ngIf="df['password'].invalid && df['password'].touched" class="error-message">
                                <i class="bi bi-exclamation-circle"></i>
                                La contraseña es requerida
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn btn-danger" [disabled]="deleting || deleteForm.invalid">
                                <i class="bi bi-trash" *ngIf="!deleting"></i>
                                <div class="loading-spinner" *ngIf="deleting"></div>
                                {{ deleting ? "Eliminando..." : "Eliminar Cuenta" }}
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Pestaña: Cerrar Sesión -->
            <div *ngIf="activeTab === 'logout'" class="tab-content">
                <div class="security-section">
                    <h3>
                        <i class="bi bi-box-arrow-right"></i>
                        Cerrar Sesión
                    </h3>
                    <p>¿Estás seguro de que quieres cerrar sesión?</p>

                    <div class="form-actions">
                        <button type="button" class="btn btn-primary" (click)="logout()">
                            <i class="bi bi-box-arrow-right"></i>
                            Sí, Cerrar Sesión
                        </button>
                        <button type="button" class="btn btn-outline-secondary" (click)="setActiveTab('profile')">
                            <i class="bi bi-x"></i>
                            Cancelar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


